<!DOCTYPE html>
<html lang="en">
<head>
  <title>NODE - REST API TEST</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <style>
 
  </style>
</head>
<body>

<div style="margin-top: -10px; background-color: #d1ecf1; border-color: #bee5eb;">
    <div class="container">
        <div class="row">
            <div class="col-sm-4">
                <label id="loginUserInfo" class="mt-3" style="font-size: 12px;"></label>
            </div>
            <div class="col-sm-8">
                <div class="mt-2 mb-2 alert alert-info text-right" style="border-radius: 0;" id="apiResponse"></div>
            </div>
        </div>
    </div>
</div>
<div class="container mt-3">
    <div id="loginArea">
        <h2>Login</h2>
        <hr/>
        <div class="row">
            <div class="col-md-6">
                <form name="loginFrm" id="loginFrm" method="POST">
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="email" class="form-control" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="password" class="form-control" placeholder="Password" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="listArea" style="display: none;">
        <div class="row">
            <div class="col-sm-6"><h2>User List (<span id="userCount"></span>)</h2></div>
            <div class="col-sm-6"><a href="javascript:void(0);" id="addUserBTN" class="btn btn-primary float-right">Add User</a></div>
        </div>
        <hr/>
        <div class="row">
            <div class="col-sm-12" style="width: 100%; height: 350px; overflow: auto;">
                <table class="table table-bordered table-striped table-hover" id="userListTab">
                    <thead>
                        <tr>
                            <th>SL</th>
                            <th>PHOTO</th>
                            <th>NAME</th>
                            <th>EMAIL ID</th>
                            <th>PHONE NO</th>
                            <th>SEX</th>
                            <th>COMPANY</th>
                            <th>SALARY</th>
                            <th>ADDRESS</th>
                            <th style="width: 140px;">#</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="viewArea" style="display: none;">
        <div class="row">
            <div class="col-sm-6">
                <h2>User Details</h2>
            </div>
            <div class="col-sm-6">
                <a href="javascript:void(0);" class="backToListBTN1 btn btn-primary float-right">User List</a>
            </div>
        </div>
        <hr/>
        <div class="row">
            <div class="col-sm-6">
                <img id="profileImage" style="width: 100px; height: 100px; border-radius:5px; border:2px solid #ddd">
                <table class="table table-bordered mt-2" id="userViewTab">
                    <tr>
                        <th>First Name:</th>
                        <td id="firstName"></td>
                    </tr>
                    <tr>
                        <th>Last Name:</th>
                        <td id="lastName"></td>
                    </tr>
                    <tr>
                        <th>Email-Id:</th>
                        <td id="emailId"></td>
                    </tr>
                    <tr>
                        <th>Phone No:</th>
                        <td id="phoneNo"></td>
                    </tr>
                    <tr>
                        <th>Sex:</th>
                        <td id="sex"></td>
                    </tr>
                    <tr>
                        <th>Date of Birth:</th>
                        <td id="dob"></td>
                    </tr>
                    <tr>
                        <th>Address:</th>
                        <td id="address"></td>
                    </tr>
                    <tr>
                        <th>City:</th>
                        <td id="city"></td>
                    </tr>
                    <tr>
                        <th>Pincode:</th>
                        <td id="pincode"></td>
                    </tr>
                    <tr>
                        <th>State:</th>
                        <td id="state"></td>
                    </tr>
                    <tr>
                        <th>Country:</th>
                        <td id="country"></td>
                    </tr>
                    <tr>
                        <th>Company:</th>
                        <td id="company"></td>
                    </tr>
                    <tr>
                        <th>Salary:</th>
                        <td id="salary"></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div id="createArea" style="display: none;">
        <div class="row">
            <div class="col-sm-6">
                <h2>Create User</h2>
            </div>
            <div class="col-sm-6">
                <a href="javascript:void(0);" class="backToListBTN2 btn btn-primary float-right">User List</a>
            </div>
        </div>
        <hr/>
        <form name="createUserFrm" id="createUserFrm" method="POST">
            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label>First Name:</label>
                        <input type="text" id="firstName" class="form-control" placeholder="First Name" required="required">
                    </div>
                    <div class="form-group">
                        <label>Last Name:</label>
                        <input type="text" id="lastName" class="form-control" placeholder="Last Name" required="required">
                    </div>
                    <div class="form-group">
                        <label>Email-Id:</label>
                        <input type="email" id="emailId" class="form-control" placeholder="Email Id" required="required">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="password" class="form-control" placeholder="Password" required="required">
                    </div>
                    <div class="form-group">
                        <label>Phone No:</label>
                        <input type="text" id="phoneNo" class="form-control" placeholder="Phone No">
                    </div>
                    <div class="form-group">
                        <label>Date of Birth:</label>
                        <input type="date" id="dob" class="form-control" placeholder="DOB">
                    </div>
                    <div class="form-group">
                        <label>Sex:</label>
                        <input type="radio" id="sex" value="male"> Male
                        <input type="radio" id="sex" value="female"> Female
                    </div>
                    <div class="form-group">
                        <label>Company Name:</label>
                        <input type="text" id="companyName" class="form-control" placeholder="Company Name" required="required">
                    </div>
                    <div class="form-group">
                        <label>Salary:</label>
                        <input type="number" id="salary" class="form-control" placeholder="Salary">
                    </div>
                    <div class="form-group">
                        <label>Address:</label>
                        <textarea id="address" class="form-control" placeholder="Address" required="required"></textarea>
                    </div>
                    <div class="form-group">
                        <label>City:</label>
                        <input type="text" id="city" class="form-control" placeholder="City">
                    </div>
                    <div class="form-group">
                        <label>Pincode:</label>
                        <input type="text" id="pincode" class="form-control" placeholder="Pincode">
                    </div>
                    <div class="form-group">
                        <label>State:</label>
                        <input type="text" id="state" class="form-control" placeholder="State">
                    </div>
                    <div class="form-group">
                        <label>Country:</label>
                        <input type="text" id="country" class="form-control" placeholder="Country">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Create</button>
                        <button type="reset" id="resetAllBTN" class="btn btn-danger">Reset All</button>
                    </div>
                </div>
                <div class="col-sm-2"></div>
                <div class="col-sm-4">
                    <div class="form-group">
                        <label>Profile Image</label> <br/>
                        <input type="file" id="uploadProfileImage" accept="image/*">
                    </div>
                </div>
            </div>
        </form>
    </div>
    <input type="hidden" id="jwtToken">
</div>
<script>
$(document).ready(function () {
    
    isStayLogin();
    
    $('#loginFrm').on('submit', function (e) {
        e.preventDefault();
        $.ajax({
            url: "http://localhost:5000/api/v1/auth/login",
            type: "POST",
            data: JSON.stringify({
                email: $('#email').val(),
                password: $('#password').val()
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            beforeSend: function () {
                $('#apiResponse').html('Please wait..');
            },
            success: function (resp, status, xhr) {
                if (xhr.status === 200 && xhr.statusText === 'OK' && status === 'success') {
                    if (resp.isSuccess == 1) {
                        authUser(resp.content.token);
                    }
                }
            },
            error: function (xhr, status, error) {
                console.log(xhr);
                console.log(status);
                console.log(error);
                if ((xhr.status === 400 || xhr.status === 500) && status === 'error') {
                    var errContain = JSON.parse(xhr.responseText);
                    if (errContain.isSuccess == 0) {
                        $('#apiResponse').html(errContain.error_msg);
                    }
                } 
            }
        });
    });

    $('body').on('click', '.viewUserBTN', function () {
        var uid = $(this).attr('id').split('_')[1];
        $.ajax({
            url: `http://localhost:5000/api/v1/users/${uid}`,
            type: "GET",
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + getToken(),
            },
            beforeSend: function () {
                $('#listArea').hide(200, function () {
                    $('#viewArea').show();
                });
                $('#apiResponse').html('Please wait..');
            },
            success: function (resp, status, xhr) {
                if (xhr.status === 200 && xhr.statusText === 'OK' && status === 'success') {
                    if (resp.isSuccess == 1) {
                        var user = resp.content.user;
                        $("#profileImage").attr('src', user.profile_image);
                        $('table#userViewTab #firstName').html(user.first_name);
                        $('table#userViewTab #lastName').html(user.last_name);
                        $('table#userViewTab #emailId').html(user.email);
                        $('table#userViewTab #phoneNo').html(user.phone);
                        $('table#userViewTab #sex').html(user.sex);
                        $('table#userViewTab #dob').html(user.dob);
                        $('table#userViewTab #address').html(user.address);
                        $('table#userViewTab #city').html(user.city);
                        $('table#userViewTab #pincode').html(user.pincode);
                        $('table#userViewTab #state').html(user.state);
                        $('table#userViewTab #country').html(user.country);
                        $('table#userViewTab #company').html(user.company_name);
                        $('table#userViewTab #salary').html(user.salary);
                        $('#apiResponse').html('');
                    }
                }
            },
            error: function (xhr, status, error) {
                console.log(xhr);
                console.log(status);
                console.log(error);
                if ((xhr.status === 400 || xhr.status === 500) && status === 'error') {
                    var errContain = JSON.parse(xhr.responseText);
                    if (errContain.isSuccess == 0) {
                        $('#apiResponse').html(errContain.error_msg);
                    }
                }
            }

        });
    });

    $('body').on('click', '.deleteUserBTN', function () {
        var uid = $(this).attr('id').split('_')[1];
        $.ajax({
            url: "http://localhost:5000/api/v1/users/delete",
            type: "DELETE",
            data: JSON.stringify({
                user_id: uid
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            headers: {
                'Authorization': 'Bearer ' + getToken(),
            },
            beforeSend: function () {
                $('#apiResponse').html('Please wait..');
            },
            success: function (resp, status, xhr) {
                if (xhr.status === 200 && xhr.statusText === 'OK' && status === 'success') {
                    if (resp.isSuccess == 1) {
                        $('table#userListTab tbody tr#tr_' + resp.content.user_id).remove();
                        $('#userCount').text(parseInt($('#userCount').text()) - 1);
                        $('#apiResponse').html('User Deleted');
                    }
                }
            },
            error: function (xhr, status, error) {
                console.log(xhr);
                console.log(status);
                console.log(error);
                if ((xhr.status === 400 || xhr.status === 500) && status === 'error') {
                    var errContain = JSON.parse(xhr.responseText);
                    if (errContain.isSuccess == 0) {
                        $('#apiResponse').html(errContain.error_msg);
                    }
                } 
            }
        });
    });

    $('body').on('click', '#addUserBTN', function () {
        changeView('#listArea', '#createArea');
    });

    $('body').on('click', '.backToListBTN2', function () {
        changeView('#createArea', '#listArea');
        getUserList();
    });

    $('body').on('click', '.backToListBTN1', function () {
        changeView('#viewArea', '#listArea');
    });

    $('#createUserFrm').on('submit', function (e) {
        e.preventDefault();
        var formData = new FormData();
        formData.append('first_name', $('#createArea #firstName').val().trim());
        formData.append('last_name', $('#createArea #lastName').val().trim());
        formData.append('email', $('#createArea #emailId').val().trim());
        formData.append('password', $('#createArea #password').val().trim());
        formData.append('phone', $('#createArea #phoneNo').val().trim());
        formData.append('dob', appDateFormat($('#createArea #dob').val().trim()));
        formData.append('sex', $('#createArea #sex').val().trim());
        formData.append('company_name', $('#createArea #companyName').val().trim());
        formData.append('salary', $('#createArea #salary').val().trim());
        formData.append('full_address', $('#createArea #address').val().trim());
        formData.append('city', $('#createArea #city').val().trim());
        formData.append('pincode', $('#createArea #pincode').val().trim());
        formData.append('state', $('#createArea #state').val().trim());
        formData.append('country', $('#createArea #country').val().trim());

        var imgFile = $("#uploadProfileImage")[0].files;
        if (imgFile.length > 0 ) {
            formData.append('profile_image', imgFile[0]);
        }

        $.ajax({
            url: "http://localhost:5000/api/v1/users/create",
            type: "POST",
            data:formData,
            processData: false,
            contentType: false,
            headers: {
                'Authorization': 'Bearer ' + getToken(),
            },
            beforeSend: function () {
                $('#apiResponse').html('Please wait..');
            },
            success: function (resp, status, xhr) {
                if (xhr.status === 200 && xhr.statusText === 'OK' && status === 'success') {
                    if (resp.isSuccess == 1) {
                        $('#resetAllBTN').trigger('click');
                        $('#apiResponse').html('User Created Successfully');
                    }
                }
            },
            error: function (xhr, status, error) {
                console.log(xhr);
                console.log(status);
                console.log(error);
                if ((xhr.status === 400 || xhr.status === 500) && status === 'error') {
                    var errContain = JSON.parse(xhr.responseText);
                    if (errContain.isSuccess == 0) {
                        $('#apiResponse').html(errContain.error_msg);
                    }
                }
            }
        });
    });

    $('body').on('click', '#appLogoutBTN', function () {
        localStorage.removeItem('nodeApiTokenHtmlAjax');
        localStorage.removeItem('nodeApiUserNameHtmlAjax');
        localStorage.removeItem('nodeApiUserEmailHtmlAjax');
        window.location.reload();
    });

    function appDateFormat(date) {
        console.log(date);
        if (date != undefined && date != '') {
            var dateArr = date.split('-');
            return dateArr[1] + '-' + dateArr[2] + '-' + dateArr[0];
        }
        return '';
    }
    
    function changeView(from, to) {
        $(from).hide(200, function () {
            $(to).show();
        });
    }
    
    function getToken() {
        return localStorage.getItem('nodeApiTokenHtmlAjax');
    }
    
    function authUser(token) {
        $.ajax({
            url: "http://localhost:5000/api/v1/users/token",
            type: "POST",
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + token,
            },
            beforeSend: function () {
                $('#apiResponse').html('Please wait..');
            },
            success: function (resp, status, xhr) {
                if (xhr.status === 200 && xhr.statusText === 'OK' && status === 'success') {
                    if (resp.isSuccess == 1) {
                        $('#jwtToken').val(token);
                        localStorage.setItem('nodeApiTokenHtmlAjax', token);
                        localStorage.setItem('nodeApiUserNameHtmlAjax', resp.content.auth_user.name);
                        localStorage.setItem('nodeApiUserEmailHtmlAjax', resp.content.auth_user.email);
                        $('#apiResponse').html('Login Successfull');
                        $('#loginUserInfo').html(`${resp.content.auth_user.name} (${resp.content.auth_user.email}) - <a href="javascript:void(0);" id="appLogoutBTN"><strong>Logout</strong></a>`);
                        getUserList();
                    } else {
                        window.location.reload();
                    }
                }
            },
            error: function (xhr, status, error) {
                console.log(xhr);
                console.log(status);
                console.log(error);
                if ((xhr.status === 400 || xhr.status === 500) && status === 'error') {
                    var errContain = JSON.parse(xhr.responseText);
                    if (errContain.isSuccess == 0) {
                        $('#apiResponse').html(errContain.error_msg);
                    }
                } 
            }
        });
    }

    function isStayLogin() {
        var _authToken = getToken();
        if (_authToken != undefined && _authToken != '' && _authToken != null) {
            authUser(_authToken);
        }
    }
    
    function getUserList() {
        $.ajax({
            url: "http://localhost:5000/api/v1/users",
            type: "GET",
            contentType: 'application/json',
            headers: {
                'Authorization': 'Bearer ' + getToken(),
            },
            beforeSend: function () {
                changeView('#loginArea', '#listArea');
                $('#apiResponse').html('Please wait..');
            },
            success: function (resp, status, xhr) {
                if (xhr.status === 200 && xhr.statusText === 'OK' && status === 'success') {
                    if (resp.isSuccess == 1) {
                        $('#userCount').text(resp.content.user_count);
                        var uTabHtml = '';
                        var sl = 1;
                        for (var i = 0; i < resp.content.users.length; i++) {
                            uTabHtml += `<tr id="tr_${resp.content.users[i].id}">
                                    <td>${sl}</td>
                                    <td><img src="${resp.content.users[i].profile_image}" style="width: 40px; height: 40px; border-radius:4px; border:1px solid #ddd;"></td>
                                    <td>${resp.content.users[i].first_name} ${resp.content.users[i].last_name}</td>
                                    <td>${resp.content.users[i].email}</td>
                                    <td>${resp.content.users[i].phone}</td>
                                    <td>${resp.content.users[i].sex ?? ''}</td>
                                    <td>${resp.content.users[i].company_name ?? ''}</td>
                                    <td>${resp.content.users[i].salary ?? ''}</td>
                                    <td>${resp.content.users[i].address ?? ''}</td>
                                    <td style="width: 140px;">
                                        <a href="javascript:void(0);" class="btn btn-primary btn-sm viewUserBTN" id="viewUser_${resp.content.users[i].id}">View</a>
                                        <a href="javascript:void(0);" class="btn btn-danger btn-sm deleteUserBTN" id="deleteUser_${resp.content.users[i].id}">Delete</a>
                                    </td>
                                </tr>`;
                            sl++;
                        }
                        $('table#userListTab tbody').html(uTabHtml);
                        $('#apiResponse').html('');
                    }
                }
            },
            error: function (xhr, status, error) {
                console.log(xhr);
                console.log(status);
                console.log(error);
                if ((xhr.status === 400 || xhr.status === 500) && status === 'error') {
                    var errContain = JSON.parse(xhr.responseText);
                    if (errContain.isSuccess == 0) {
                        $('#apiResponse').html(errContain.error_msg);
                    }
                }
            }
        });
    }

});
</script>
</body>
</html>
